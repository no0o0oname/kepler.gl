<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Kepler.gl embedded map</title>

    <!--Uber Font-->
    <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css">

    <!--MapBox css-->
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css" rel="stylesheet">

    <!-- Load React/Redux -->
    <script src="https://unpkg.com/react@16.8.4/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js" crossorigin></script>

    <!-- Load Kepler.gl-->
    <script src="http://10.168.161.158/keplergl.min.js"></script>
    <!--If you want to load the build from filepath -->
    <!--<script src="../../umd/keplergl.min.js"></script>-->

    <style type="text/css">
      body {margin: 0; padding: 0; overflow: hidden;}
      rightPanel {position: absolute;
        z-index: 100;
        bottom: 10px;
        right: 10px;
        background-color: #06de90;
        font-size: 11px;
        width: 300px;
        color: #dddddd;
        word-wrap: break-word;
        min-height: 60px;
        padding: 10px;
        }
    </style>

    <!--MapBox token-->
    <script>

      /**
       * Provide your json file name
       **/
      var json_file = 'bjss.json'

      /**
       * Provide your MapBox Token, you may not change this.
       **/

      const MAPBOX_TOKEN = 'pk.eyJ1IjoibjBuYW1lIiwiYSI6ImNqeXo1eG90ZDAzOWczaG54dGp4cWhlcmYifQ.xMyKDeImcCPf8nLij2YiHw';



      const theme = {
        sidePanelBg: '#ffffff',
        titleTextColor: '#000000',
        sidePanelHeaderBg: '#f7f7F7',
        subtextColorActive: '#2473bd',
        tooltipBg: '#1869b5',
        tooltipColor: '#ffffff',
        dropdownListBgd: '#ffffff',
        textColorHl: '#2473bd',
        inputBgd: '#f7f7f7',
        inputBgdHover: '#ffffff',
        inputBgdActive: '#ffffff',
        dropdownListHighlightBg: '#f0f0f0',
        panelBackground: '#f7f7F7',
        panelBackgroundHover: '#f7f7F7',
        secondaryInputBgd: '#f7f7F7',
        secondaryInputBgdActive: '#f7f7F7',
        secondaryInputBgdHover: '#ffffff',
        panelActiveBg: '#f7f7F7'
      };
    </script>

  </head>
  <body>
    <!-- We will put our React component inside this div. -->
    <div id="app">
      <!-- Kepler.gl map will be placed here-->
    </div>
    <div class='rightPanel'>

    </div>

    <!-- Load our React component. -->
    <script>
      /* Validate Mapbox Token */
      if ((MAPBOX_TOKEN || '') === '' || MAPBOX_TOKEN === 'PROVIDE_MAPBOX_TOKEN') {
        alert(WARNING_MESSAGE);
      }

      /** STORE **/
      const reducers = (function createReducers(redux, keplerGl) {
        const customizedKeplerGlReducer = keplerGl.keplerGlReducer.initialState({
          uiState: {
            // use Chinese locale
            locale: 'cn',

            // customize which map control button to show
            mapControls: {
              visibleLayers: {
                show: false
              },
              mapLegend: {
                show: true,
                active: false
              },
              toggle3d: {
                show: true
              },
              splitMap: {
                show: false
              }
            }
          }
        });

        return redux.combineReducers({
          // mount keplerGl reducer
          keplerGl: customizedKeplerGlReducer
        });
      }(Redux, KeplerGl));

      const middleWares = (function createMiddlewares(keplerGl) {
        return keplerGl.enhanceReduxMiddleware([
          // Add other middlewares here
        ]);
      }(KeplerGl));

      const enhancers = (function craeteEnhancers(redux, middles) {
        return redux.applyMiddleware(...middles);
      }(Redux, middleWares));

      const store = (function createStore(redux, enhancers) {
        const initialState = {
        };

        return redux.createStore(
          reducers,
          initialState,
          redux.compose(enhancers)
        );
      }(Redux, enhancers));
      /** END STORE **/

      /** COMPONENTS **/
      const KeplerElement = (function (react, keplerGl, mapboxToken) {
        return function(props) {
          return react.createElement(
            'div',
            {style: {position: 'absolute', left: 0, width: '100vw', height: '100vh'}},
            react.createElement(
              keplerGl.KeplerGl,
              {
                mapboxApiAccessToken: mapboxToken,
                id: 'map',
                theme: 'light',
                width: window.innerWidth,
                height: window.innerHeight
              }
            )
          )
        }
      }(React, KeplerGl, MAPBOX_TOKEN));

      const app = (function createReactReduxProvider(react, reactRedux, KeplerElement) {
        return react.createElement(
          reactRedux.Provider,
          {store},
          react.createElement(KeplerElement, null)
        )
      }(React, ReactRedux, KeplerElement));
      /** END COMPONENTS **/

      /** Render **/
      (function render(react, reactDOM, app) {
        reactDOM.render(app, document.getElementById('app'));
      }(React, ReactDOM, app));

    </script>

    <!-- The next script will show how to interact directly with Kepler map store -->
    <script>
      /**
       * Customize map.
       * Interact with map store to customize data and behavior
       */
      //通过HTTP请求获取数据json
      let requestURL = 'http://10.168.161.158/json/'+json_file;
      let request = new XMLHttpRequest();
      request.open('GET', requestURL);
      request.responseType = 'json';
      request.send();
      request.onload = function() {
        let data = request.response;

        let datasets = data.datasets;
        let config = data.config;

        const loadedData = KeplerGl.KeplerGlSchema.load(
          datasets,
          config
        );

        store.dispatch(KeplerGl.addDataToMap({
          datasets: loadedData.datasets,
          config: loadedData.config,
          options: {
            centerMap: false
          }
        }));

      };
    </script>
  </body>
</html>
