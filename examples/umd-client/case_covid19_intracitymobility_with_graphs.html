<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Kepler.gl embedded map</title>

    <!--Uber Font-->
    <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css">

    <!--MapBox css-->
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css" rel="stylesheet">

    <!-- Load React/Redux -->
    <script src="https://unpkg.com/react@16.8.4/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js" crossorigin></script>
    <!-- Load echarts and jQuery-->
    <script type="text/javascript" src="http://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"> </script>

    <!-- Load Kepler.gl-->
    <script src="http://10.168.161.158/keplergl.min.js"></script>
    <!--If you want to load the build from filepath -->
    <!--<script src="../../umd/keplergl.min.js"></script>-->

    <style type="text/css">
      body {margin: 0; padding: 0; overflow: hidden;}
    </style>

    <!--MapBox token-->
    <script>

      /**
       * Provide your json file name
       **/
      var kepler_json_file = 'covid19_intracitymobility.json';
      var echarts_json_file = 'Yaxi_Plotting_IntraMobilityCurve.json';

      /**
       * Provide your MapBox Token, you may not change this.
       **/

      const MAPBOX_TOKEN = 'pk.eyJ1IjoibjBuYW1lIiwiYSI6ImNqeXo1eG90ZDAzOWczaG54dGp4cWhlcmYifQ.xMyKDeImcCPf8nLij2YiHw';



      const theme = {
        sidePanelBg: '#ffffff',
        titleTextColor: '#000000',
        sidePanelHeaderBg: '#f7f7F7',
        subtextColorActive: '#2473bd',
        tooltipBg: '#1869b5',
        tooltipColor: '#ffffff',
        dropdownListBgd: '#ffffff',
        textColorHl: '#2473bd',
        inputBgd: '#f7f7f7',
        inputBgdHover: '#ffffff',
        inputBgdActive: '#ffffff',
        dropdownListHighlightBg: '#f0f0f0',
        panelBackground: '#f7f7F7',
        panelBackgroundHover: '#f7f7F7',
        secondaryInputBgd: '#f7f7F7',
        secondaryInputBgdActive: '#f7f7F7',
        secondaryInputBgdHover: '#ffffff',
        panelActiveBg: '#f7f7F7'
      };
    </script>

  </head>
  <body>
    <!-- We will put our React component inside this div. -->
    <div id="app">
      <!-- Kepler.gl map will be placed here-->
    </div>


    <!-- Load our React component. -->
    <script>
      /* Validate Mapbox Token */
      if ((MAPBOX_TOKEN || '') === '' || MAPBOX_TOKEN === 'PROVIDE_MAPBOX_TOKEN') {
        alert(WARNING_MESSAGE);
      }

      /** STORE **/
      const reducers = (function createReducers(redux, keplerGl) {
        const customizedKeplerGlReducer = keplerGl.keplerGlReducer.initialState({
          uiState: {
            // use Chinese locale
            locale: 'cn',

            // customize which map control button to show
            mapControls: {
              visibleLayers: {
                show: false
              },
              mapLegend: {
                show: true,
                active: false
              },
              toggle3d: {
                show: true
              },
              splitMap: {
                show: false
              }
            }
          }
        });

        return redux.combineReducers({
          // mount keplerGl reducer
          keplerGl: customizedKeplerGlReducer
        });
      }(Redux, KeplerGl));

      const middleWares = (function createMiddlewares(keplerGl) {
        return keplerGl.enhanceReduxMiddleware([
          // Add other middlewares here
        ]);
      }(KeplerGl));

      const enhancers = (function craeteEnhancers(redux, middles) {
        return redux.applyMiddleware(...middles);
      }(Redux, middleWares));

      const store = (function createStore(redux, enhancers) {
        const initialState = {
        };

        return redux.createStore(
          reducers,
          initialState,
          redux.compose(enhancers)
        );
      }(Redux, enhancers));
      /** END STORE **/

      /** COMPONENTS **/
      const echartsBottomContainer = React.createElement(
        'div',
        {
          style:
            {
              position: 'absolute',
              zIndex: '100',
              bottom: '0px',
              right: '0px',
              backgroundColor: 'RGBA(30,40,48,0.5)',
              fontSize: '11px',
              width: '100%',
              height:'30%',
              color: KeplerGl.theme.textColor,
              padding: KeplerGl.theme.mapControl.padding,
              boxShadow: KeplerGl.theme.panelBoxShadow,
            },
          id:'graphContainerBottom',
        },
      );
      function CustomBottomWidgetFactory() {
        const BottomWidget = KeplerGl.BottomWidgetFactory();
        const CustomBottomWidget = props => {
          return null
        };
        return CustomBottomWidget;
      }
      const keplerCustomized = KeplerGl.injectComponents([
        [KeplerGl.BottomWidgetFactory, CustomBottomWidgetFactory],
      ]);

      const KeplerElement = (function (react, keplerGl, mapboxToken) {
        return function(props) {
          return react.createElement(
            'div',
            {style: {position: 'absolute', left: 0, width: '100vw', height: '100vh'}},
            react.createElement(
              keplerGl.KeplerGl,
              {
                mapboxApiAccessToken: mapboxToken,
                id: 'map',
                theme: 'light',
                width: window.innerWidth,
                height: window.innerHeight
              }
            ),
            echartsBottomContainer
          )
        }
      }(React, KeplerGl, MAPBOX_TOKEN));

      const app = (function createReactReduxProvider(react, reactRedux, KeplerElement) {
        return react.createElement(
          reactRedux.Provider,
          {store},
          react.createElement(KeplerElement, null)
        )
      }(React, ReactRedux, KeplerElement));
      /** END COMPONENTS **/

      /** Render **/
      (function render(react, reactDOM, app) {
        reactDOM.render(app, document.getElementById('app'));
      }(React, ReactDOM, app));

    </script>

    <!-- The next script will show how to interact directly with Kepler map store -->
    <script>
      /**
       * Customize map.
       * Interact with map store to customize data and behavior
       */

      //通过HTTP请求获取数据json
      let requestURL = 'http://10.168.161.158/json/'+kepler_json_file;
      let request = new XMLHttpRequest();
      request.open('GET', requestURL);
      request.responseType = 'json';
      request.send();
      request.onload = async function() {
        let data = request.response;

        let datasets = data.datasets;
        let config = data.config;

        const loadedData = KeplerGl.KeplerGlSchema.load(
          datasets,
          config
        );



        await store.dispatch(KeplerGl.addDataToMap({
          datasets: loadedData.datasets,
          config: loadedData.config,
          options: {
            centerMap: false
          }
        }));

        store.dispatch(KeplerGl.toggleSidePanel());
        store.dispatch(KeplerGl.enlargeFilter(0));

        function sleep (time) {
          return new Promise((resolve) => setTimeout(resolve, time));
        }

        sleep(5000).then(() => {
          $.get(
            'http://10.168.161.158/json/'+echarts_json_file,
            function (_rawData) {
              //store.dispatch(Kepler)
              store.dispatch(KeplerGl.updateFilterAnimationSpeed(0,4));
              store.dispatch(KeplerGl.toggleFilterAnimation(0));
              plot_echarts(_rawData);
            }
          );
        })

      };
    </script>


    <script type="text/javascript">
      var dom = document.getElementById("graphContainerBottom");

      var myChart = echarts.init(dom);
      var option;


      function plot_echarts(_rawData) {
        const countries = [
          '全国均值',
          '北京市',
          '上海市',
          '广州市',
          '深圳市'
        ];
        const datasetWithFilters = [];
        const seriesList = [];
        echarts.util.each(countries, function (country) {
          var datasetId = 'dataset_' + country;
          datasetWithFilters.push({
            id: datasetId,
            fromDatasetId: 'dataset_raw',
            transform: {
              type: 'filter',
              config: {
                and: [
                  { dimension: 'City', '=': country }
                ]
              }
            }
          });
          seriesList.push({
            type: 'line',
            datasetId: datasetId,
            showSymbol: true,
            name: country,
            endLabel: {
              show: true,
              formatter: function (params) {
                return params.value[0] + ': ' + params.value[1];
              }
            },
            labelLayout: {
              moveOverlap: 'shiftY'
            },
            emphasis: {
              focus: 'series'
            },
            encode: {
              x: 'Date',
              y: 'MI',
              label: ['City', 'MI'],
              itemName: 'Date',
              tooltip: ['MI']
            }
          });
        });
        option = {
          textStyle:{
            color: '#ddd',
          },
          animationDuration: 17000,
          grid: {
            left: '6%',
            right: '10%',
            bottom: '3%',
            top: '15%',
            containLabel: true
          },
          axisPointer:{
            label: {
              color: 'white'
            },
          },
          dataset: [
            {
              id: 'dataset_raw',
              source: _rawData
            },
            ...datasetWithFilters
          ],
          title: {
            text: '城市内部活动强度变化',
            left: 'center',
            textStyle: {
              fontSize: 20,
              color: '#ddd'
            }
          },
          tooltip: {
            order: 'valueDesc',
            trigger: 'axis',
          },
          xAxis: {
            type: 'category',
            nameLocation: 'middle',
            axisLabel: {
              color: '#ddd',
              fontSize: 12
            },
            nameTextStyle: {
              color: '#ddd',
              fontSize: 12
            },
          },
          yAxis: {
            name: '活动强度指数',
            splitLine: {
              show: false
            },
            nameTextStyle: {
              color: '#ddd',
              fontSize: 12
            },
            axisLabel: {
              color: '#ddd',
              fontSize: 12
            }
          },
          series: seriesList
        };
        myChart.setOption(option);
      }

      if (option && typeof option === 'object') {
        myChart.setOption(option);
      }

    </script>
  </body>
</html>
