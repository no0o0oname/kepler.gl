<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Kepler.gl embedded map</title>

    <!--Uber Font-->
    <link rel="stylesheet" href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/uber-fonts/4.0.0/superfine.css">

    <!--MapBox css-->
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css" rel="stylesheet">

    <!-- Load React/Redux -->
    <script src="https://unpkg.com/react@16.8.4/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8.4/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js" crossorigin></script>
    <!-- Load echarts and jQuery-->
    <script type="text/javascript" src="http://cdn.jsdelivr.net/npm/echarts@5.2.2/dist/echarts.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"> </script>

    <!-- Load Kepler.gl-->
    <script src="http://10.168.161.158/keplergl.min.js"></script>
    <!--If you want to load the build from filepath -->
    <!--<script src="../../umd/keplergl.min.js"></script>-->

    <style type="text/css">
      body {margin: 0; padding: 0; overflow: hidden;}
    </style>

    <!--MapBox token-->
    <script>

      /**
       * Provide your json file name
       **/
      var kepler_json_file = 'case_covid19hosp.json';
      //var echarts_json_file = 'Yaxi_Plotting_IntraMobilityCurve.json';

      /**
       * Provide your MapBox Token, you may not change this.
       **/

      const MAPBOX_TOKEN = 'pk.eyJ1IjoibjBuYW1lIiwiYSI6ImNqeXo1eG90ZDAzOWczaG54dGp4cWhlcmYifQ.xMyKDeImcCPf8nLij2YiHw';



      const theme = {
        sidePanelBg: '#ffffff',
        titleTextColor: '#000000',
        sidePanelHeaderBg: '#f7f7F7',
        subtextColorActive: '#2473bd',
        tooltipBg: '#1869b5',
        tooltipColor: '#ffffff',
        dropdownListBgd: '#ffffff',
        textColorHl: '#2473bd',
        inputBgd: '#f7f7f7',
        inputBgdHover: '#ffffff',
        inputBgdActive: '#ffffff',
        dropdownListHighlightBg: '#f0f0f0',
        panelBackground: '#f7f7F7',
        panelBackgroundHover: '#f7f7F7',
        secondaryInputBgd: '#f7f7F7',
        secondaryInputBgdActive: '#f7f7F7',
        secondaryInputBgdHover: '#ffffff',
        panelActiveBg: '#f7f7F7'
      };
    </script>

  </head>
  <body>
    <!-- We will put our React component inside this div. -->
    <div id="app">
      <!-- Kepler.gl map will be placed here-->
    </div>


    <!-- Load our React component. -->
    <script>
      /* Validate Mapbox Token */
      if ((MAPBOX_TOKEN || '') === '' || MAPBOX_TOKEN === 'PROVIDE_MAPBOX_TOKEN') {
        alert(WARNING_MESSAGE);
      }

      /** STORE **/
      const reducers = (function createReducers(redux, keplerGl) {
        const customizedKeplerGlReducer = keplerGl.keplerGlReducer.initialState({
          uiState: {
            // use Chinese locale
            locale: 'cn',

            // customize which map control button to show
            mapControls: {
              visibleLayers: {
                show: false
              },
              mapLegend: {
                show: true,
                active: false
              },
              toggle3d: {
                show: true
              },
              splitMap: {
                show: false
              }
            }
          }
        });

        return redux.combineReducers({
          // mount keplerGl reducer
          keplerGl: customizedKeplerGlReducer
        });
      }(Redux, KeplerGl));

      const middleWares = (function createMiddlewares(keplerGl) {
        return keplerGl.enhanceReduxMiddleware([
          // Add other middlewares here
        ]);
      }(KeplerGl));

      const enhancers = (function craeteEnhancers(redux, middles) {
        return redux.applyMiddleware(...middles);
      }(Redux, middleWares));

      const store = (function createStore(redux, enhancers) {
        const initialState = {
        };

        return redux.createStore(
          reducers,
          initialState,
          redux.compose(enhancers)
        );
      }(Redux, enhancers));
      /** END STORE **/

      /** COMPONENTS **/
      const echartsBottomContainer = React.createElement(
        'div',
        {
          style:
            {
              position: 'absolute',
              zIndex: '100',
              bottom: '0px',
              right: '0px',
              backgroundColor: 'white',
              fontSize: '11px',
              width: '350px',
              height:'40%',
              color: KeplerGl.theme.textColor,
              padding: KeplerGl.theme.mapControl.padding,
              boxShadow: KeplerGl.theme.panelBoxShadow,
            },
          id:'graphContainerBottom',
        },
      );
      function CustomBottomWidgetFactory() {
        const BottomWidget = KeplerGl.BottomWidgetFactory();
        const CustomBottomWidget = props => {
          return null
        };
        return CustomBottomWidget;
      }
      const keplerCustomized = KeplerGl.injectComponents([
        [KeplerGl.BottomWidgetFactory, CustomBottomWidgetFactory],
      ]);

      const KeplerElement = (function (react, keplerGl, mapboxToken) {
        return function(props) {
          return react.createElement(
            'div',
            {style: {position: 'absolute', left: 0, width: '100vw', height: '100vh'}},
            react.createElement(
              keplerGl.KeplerGl,
              {
                mapboxApiAccessToken: mapboxToken,
                id: 'map',
                theme: 'light',
                width: window.innerWidth,
                height: window.innerHeight
              }
            ),
            echartsBottomContainer
          )
        }
      }(React, KeplerGl, MAPBOX_TOKEN));

      const app = (function createReactReduxProvider(react, reactRedux, KeplerElement) {
        return react.createElement(
          reactRedux.Provider,
          {store},
          react.createElement(KeplerElement, null)
        )
      }(React, ReactRedux, KeplerElement));
      /** END COMPONENTS **/

      /** Render **/
      (function render(react, reactDOM, app) {
        reactDOM.render(app, document.getElementById('app'));
      }(React, ReactDOM, app));

    </script>

    <!-- The next script will show how to interact directly with Kepler map store -->
    <script>
      /**
       * Customize map.
       * Interact with map store to customize data and behavior
       */
      //通过HTTP请求获取数据json
      let requestURL = 'http://10.168.161.158/json/'+kepler_json_file;
      let request = new XMLHttpRequest();
      request.open('GET', requestURL);
      request.responseType = 'json';
      request.send();
      request.onload = async function() {
        let data = request.response;

        let datasets = data.datasets;
        let config = data.config;

        const loadedData = KeplerGl.KeplerGlSchema.load(
          datasets,
          config
        );

        await store.dispatch(KeplerGl.addDataToMap({
          datasets: loadedData.datasets,
          config: loadedData.config,
          options: {
            centerMap: false
          }
        }));

        store.dispatch(KeplerGl.enlargeFilter(0))
        $.get(
          'http://10.168.161.158/json/'+echarts_json_file,
          function (_rawData) {
            store.dispatch(Kepler)
            store.dispatch(KeplerGl.updateFilterAnimationSpeed(0,4));
            store.dispatch(KeplerGl.toggleFilterAnimation(0));
            plot_echarts(_rawData);
          }
        );

      };
    </script>

  <script>
    var dom = document.getElementById("graphContainerBottom");
    var myChart = echarts.init(dom);

    var option;



    option = {
      grid: {
        left: '6%',
        right: '3%',
        bottom: '3%',
        top: '15%',
        containLabel: true
      },
      // title: {
      //   text: '时间序列滞后分析'
      // },
      tooltip: {
        trigger: 'axis'
      },
      legend: {},
      // toolbox: {
      //   show: true,
      //   feature: {
      //     dataZoom: {
      //       yAxisIndex: 'none'
      //     },
      //     dataView: { readOnly: false },
      //     magicType: { type: ['line', 'bar'] },
      //     restore: {},
      //     saveAsImage: {}
      //   }
      // },
      xAxis: {
        type: 'category',
        boundaryGap: false,
        data: ['2020-01-11','2020-01-12','2020-01-13','2020-01-14','2020-01-15','2020-01-16','2020-01-17','2020-01-18','2020-01-19','2020-01-20','2020-01-21','2020-01-22','2020-01-23','2020-01-24','2020-01-25','2020-01-26','2020-01-27','2020-01-28','2020-01-29','2020-01-30','2020-01-31','2020-02-01','2020-02-02','2020-02-03','2020-02-04','2020-02-05','2020-02-06','2020-02-07','2020-02-08','2020-02-09','2020-02-10','2020-02-11','2020-02-12','2020-02-13','2020-02-14','2020-02-15','2020-02-16','2020-02-17','2020-02-18','2020-02-19','2020-02-20','2020-02-21','2020-02-22','2020-02-23','2020-02-24','2020-02-25','2020-02-26','2020-02-27','2020-02-28','2020-02-29','2020-03-01','2020-03-02','2020-03-03','2020-03-04','2020-03-05','2020-03-06','2020-03-07','2020-03-08','2020-03-09','2020-03-10','2020-03-11','2020-03-12','2020-03-13','2020-03-14','2020-03-15','2020-03-16','2020-03-17','2020-03-18','2020-03-19','2020-03-20','2020-03-21','2020-03-22','2020-03-23','2020-03-24','2020-03-25','2020-03-26','2020-03-27','2020-03-28','2020-03-29','2020-03-30','2020-03-31']
      },
      yAxis: {
        type: 'value',
        // axisLabel: {
        //   formatter: '{value} °C'
        // }
      },
      series: [
        {
          name: '市内出行强度',
          type: 'line',
          data: [1.61665009107468,1.6065116575592,1.7562156648451734,1.7393996357012733,1.7317248633879767,1.75110573770492,1.7731820582877968,1.6651128415300567,1.7419839708561,1.7900872495446267,1.7667776867030967,1.7522721311475402,1.66169180327869,1.3927688524590167,1.1916597449908932,1.1815255009107466,1.0243558287796,0.94630519125683,0.9071055555555567,0.87701329690346,0.8457043715847,0.8176265938069234,0.7772480874316933,0.80546839708561,0.7658766848816033,0.7392775045537333,0.7054862477231333,0.7234555555555566,0.69616839708561,0.6900080145719466,0.76838096539162,0.7548507285974501,0.7713196721311467,0.7809437158469934,0.7800178506375234,0.6922971766848834,0.7044879781420766,0.8420914389799633,0.86245081967213,0.8888837887067399,0.91699189435337,0.9609567395264134,0.9309479052823301,0.9426188524590167,1.12069043715847,1.1193475409836067,1.1328663023679433,1.1220738615664867,1.15140883424408,1.1220475409836066,1.12241047358834,1.25429927140255,1.2392900728597434,1.24793078324226,1.2835695810564667,1.30715746812386,1.2409139344262299,1.2338944444444433,1.3573800546448098,1.3939537340619301,1.4145659380692166,1.4130041894353367,1.4426424408014566,1.3781164845173033,1.3632660291438967,1.5026744080145702,1.5111859744990868,1.52021757741348,1.5292239526411633,1.57089635701275,1.4824801457194898,1.45654480874317,1.59385081967213,1.5881,1.5905768670309666,1.5604234972677602,1.5865483606557367,1.4915762295081967,1.4357313296903467,1.6011733151183967,1.59452422586521]
        },
        {
          name: '时间风险',
          type: 'line',
          data: [0.908,0.903,0.895,0.886,0.871,0.851,0.824,0.788,0.757,0.757,0.788,0.889,1.04,1.231,1.597,1.746,1.658,1.726,1.78,1.808,1.799,1.748,1.689,1.647,1.554,1.489,1.459,1.41,1.389,1.348,1.323,1.301,1.047,0.991,0.971,0.959,0.942,0.925,0.908,0.902,0.904,0.901,0.896,0.892,0.887,0.883,0.879,0.876,0.872,0.866,0.864,0.864,0.863,0.862,0.862,0.86,0.859,0.859,0.859,0.859,0.859,0.859,0.859,0.86,0.86,0.86,0.86,0.86,0.861,0.861,0.862,0.861,0.862,0.862,0.862,0.863,0.864,0.865,0.865,0.866,0.866],
          color: 'red',
          markPoint: {
            data: [{ name: '周最低', value: -2, xAxis: 1, yAxis: -1.5 }]
          },
          markArea: {
            itemStyle: {
              color: 'rgba(255, 173, 177, 0.4)'
            },
            data: [
              [
                {
                  name: '滞后期',
                  xAxis: '2020-01-20'
                },
                {
                  xAxis: '2020-01-30'
                }
              ]
            ]
          }
        }
      ]
    };

    if (option && typeof option === 'object') {
      myChart.setOption(option);
    }


  </script>

  </body>
</html>
